#----------------------------------------------------------------------------------------------
#  Makefile for AviUtl plugins
#----------------------------------------------------------------------------------------------

include config.mak

vpath %.c $(SRCDIR)
vpath %.h $(SRCDIR)
vpath %.rc $(SRCDIR)

OBJ_INPUT = $(SRC_INPUT:%.c=%.o) lwinput.res

SRC_ALL = $(SRC_INPUT)

RCFLAGS = -J rc -O coff

ifneq ($(STRIP),)
LDFLAGS += -Wl,-s
endif

.PHONY: all input clean distclean dep

all: input

input: lwinput.aui2

lwinput.aui2: $(OBJ_INPUT)
	$(LD) $(LDFLAGS) -o $@ $^ $(LIBS)

%.o: %.c .depend
	$(CC) $(CFLAGS) -c $< -o $@

%.res: %.rc resource.h
	$(RC) $(RCFLAGS) $< -o $@

clean:
	$(RM) *.aui2 *.o *.res .depend

distclean: clean
	$(RM) config.*

dep: .depend

ifneq ($(wildcard .depend),)
include .depend
endif

.depend: config.mak
	@$(RM) .depend
	@$(foreach SRC, $(SRC_ALL:%=$(SRCDIR)/%), $(CC) $(SRC) $(CFLAGS) -msse4.1 -g0 -MT $(SRC:$(SRCDIR)/%.c=%.o) -MM >> .depend;)

config.mak:
	configure
